{extend name="public/common"}

{block name="style"}
<title>物业报修</title>
<link rel="stylesheet" href="/index/css/service/detail.css">
<style>
    body{
        background-color: #f0eff5;
    }
</style>
{/block}

{block name="body"}
<div id="app">
    <div class="card">
        <div class="card-tit">物业报修</div>
        <div class="card-cell">
            <span>服务类型</span>
            <span @click="checkRepair" >
                <span :class="[!defaultData.type ? 'select-color' : '', '']">{{RepairStatus}}</span> <i class="allow-right"></i>
            </span>

            <mt-popup  position="bottom"  v-model="popupVisible" class="mint-popup">
                <div class="picker-toolbar">
                    <span class="mint-datetime-action mint-datetime-cancel" @click="cancelRepair">取消</span>
                    <span class="mint-datetime-action mint-datetime-confirm" @click="selectRepair">确定</span>
                </div>
                <mt-picker :slots="slots" @change="onRepairChange" ></mt-picker>
            </mt-popup>
        </div>
        <div class="card-cell">
            <label for="name">服务地点</label>
            <input type="text" placeholder="请输入服务地点" id="name" v-model="defaultData.address">
        </div>
        <div class="card-cell">
            <span>联系人员</span>
            <span>{{subData.name}}</span>
        </div>
        <div class="card-cell">
            <span>联系电话</span>
            <span>{{subData.mobile}}</span>
        </div>
    </div>
    <div class="card">
        <div class="card-tit">备注信息</div>
        <div class="card-area">
            <textarea    v-model="defaultData.extra" class="group-area" maxlength="200"></textarea>
        </div>
        <div class="card-upload">
            <div class="img-box" >
                <div class="upload-box" @click="imgUpload" v-if="dataUrl === ''">
                    <img src="/index/images/service/card/card-camera.png" >
                    <span class="upload-info" >上传凭证</span>
                </div>
                <div class="upload-img" v-else>
                    <img :src="dataUrl" class="img-responsive">
                </div>
            </div>
        </div>
        <input type="file" class="hide" id="upImg" accept="image/jpg, image/png, image/gif, image/jpeg" @change="handleFileChange" ref="upimg">
    </div>
    <p class="prompt-message">资讯电话：{{subData.propretyMobile}}</p>
    <div class="card-more">
        <button class="btn btn-warning btn-warning-outlined btn-sm" @click="paymentInfo"><i class="icon icon-record"></i>预约记录</button>
    </div>
    <div class="card-btn-box payment-btn">
        <button class="btn btn-block btn-warning" @click="orderBtn">确定预约</button>
    </div>

</div>
{/block}

{block name="script"}
<script>
    var defaultData = {
        type:0,
        extra:'',
        address:''
    };
    var data = {$info};
    console.log(data);

    var vm = new Vue({
        el:"#app",
        computed:{
            RepairStatus:function () {
                var text = "";
                if(!this.defaultData.type){
                    text = "请选择"
                }else {
                    switch (this.defaultData.type){
                        case 1:
                             text = "空调维修";
                        break;
                        case 2:
                            text = "电梯维修";
                        break;
                        case 3:
                            text = "其他维修";
                        break;
                    }
                }
                return text;
            }
        },
        data:{
            defaultData:defaultData,
            subData:data,
            dataUrl:'',
            popupVisible: false,
            repairPicker:'',
            repairTxt:'',
            isSubmit:true,
            slots: [
                {
                    values: ['空调维修','电梯维修','其他维修']
                }
            ]
        },
        methods: {
            imgPreview (file) {
                let self = this;
                // 看支持不支持FileReader
                if (!file || !window.FileReader) return;

                if (/^image/.test(file.type)) {
                    // 创建一个reader
                    var reader = new FileReader();
                    // 将图片将转成 base64 格式
                    reader.readAsDataURL(file);
                    // 读取成功后的回调
                    reader.onloadend = function () {
                        self.dataUrl = this.result;
                    }
                }
            },
            imgUpload:function () {
                var upImg = this.$refs.upimg;
                upImg.click();
            },
            handleFileChange:function (e) {
                var _this = this;
                var upImg = _this.$refs.upimg;
                var img = upImg.files[0];
                console.log(img);
                // 在获取到文件对象进行预览就行了！
                this.imgPreview(img);
                if(img){
                    var newSize = (img.size/1024).toFixed(2);
                    if(newSize <= 10240){
                        var formData = new FormData();
                        formData.append("picture",img);
//                        return;
                        _this.$http.post("{:Url('File/uploadPicture')}",formData).then(function (res) {
                            var data = res.data;
                            console.log(data);
                        },function (res) {

                        });
                    }
                }
            },
            checkRepair: function () {
                this.popupVisible = true;
                if(!this.defaultData.type){
                    this.repairPicker.setSlotValue(0, '空调维修');
                }
            },
            onRepairChange: function (picker,values) {
                this.repairPicker =  picker;
                if(values[0]){
                    this.repairTxt = values[0];
                }
            },
            cancelRepair: function () {
                this.popupVisible = false;
            },
            selectRepair: function () {
                this.popupVisible = false;
                switch (this.repairTxt){
                    case "空调维修":
                        this.defaultData.type = 1;
                        break;
                    case "电梯维修":
                        this.defaultData.type = 2;
                        break;
                    case "其他维修":
                        this.defaultData.type = 3;
                        break;
                }
            },
            paymentInfo:function () {
                window.location.href='/index/service/history/'
            },
            orderBtn: function () {
                var _this = this;
                if(!_this.defaultData.type){
                    _this.$toast('');
                    return;
                }
                if(!_this.defaultData.address){
                    _this.$toast('');
                    return;
                }
                if(!_this.defaultData.extra){
                    _this.$toast('');
                    return;
                }

                if(!_this.isSubmit){
                    return;
                }
                _this.isSubmit = false;
                var subData = JSON.parse(JSON.stringify(_this.subData));
                var defaultData =  JSON.parse(JSON.stringify(_this.defaultData));
                var data = Object.assign(subData,defaultData);
                console.log(_this.defaultData);
                console.log(subData);
                console.log(data);
                this.$http.post("{:Url('index/Service/repair')}",data).then(function (res) {
                    _this.isSubmit = true;
                    console.log(res.data);
                },function (res) {
                    _this.isSubmit = true;
                    console.log(res.data);
                })
            }
        }
    })
</script>
{/block}