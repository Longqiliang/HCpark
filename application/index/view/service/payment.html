{extend name="public/common"}

{block name="style"}
<title>车卡服务</title>
<link rel="stylesheet" href="/index/css/service/detail.css">
<style>
    body{
        background-color: #f0eff5;
    }
</style>
{/block}

{block name="body"}
<div id="app">
    <div class="card">
        <div class="card-tit">缴费信息</div>
        <div class="card-cell">
            <span>银行账户</span>
            <span>{{subData.bank_user}}</span>
        </div>
        <div class="card-cell">
            <span>账号名称</span>
            <span>{{subData.payment_bank}}</span>
        </div>
        <div class="card-cell bottom-inherit">
            <span class="card-hr">— — — or — — —</span>
        </div>
        <div class="card-cell">
            <span>支付宝账号</span>
            <span>{{subData.payment_alipay}}</span>
        </div>
        <div class="card-cell">
            <span>账号名称</span>
            <span>{{subData.ailpay_user}}</span>
        </div>
    </div>
    <p class="prompt-message">转账时请备注个人信息（转账事由及内容）</p>
    <div class="card">
        <div class="card-tit">办理信息</div>
        <div class="card-upload">
            <div class="img-box" >
                <div class="upload-box" @click="imgUpload" v-if="dataUrl === ''">
                    <img src="/index/images/service/card/card-camera.png" >
                    <span class="upload-info" >上传凭证</span>
                </div>
                <div class="upload-img" v-else>
                    <img :src="dataUrl" class="img-responsive">
                </div>
            </div>
        </div>
        <input type="file" class="hide" id="upImg" accept="image/jpg, image/png, image/gif, image/jpeg" @change="handleFileChange" ref="upimg">
    </div>
    <div class="card-btn-box payment-btn">
        <button class="btn btn-block btn-warning" @click="subBtn">提交</button>
    </div>
</div>
{/block}

{block name="script"}
<script>
   var data = window.sessionStorage.getItem("data");
    if(data){
        data = JSON.parse(data);
        data.payment_voucher =[1,2,3];
    }
    console.log(data);
    var vm = new Vue({
        el:"#app",
        data:{
            subData:data,
            isSubmit:true,
            imgLength:3,
            payment_voucher:[],
            dataUrl:''
        },
        methods: {
            imgPreview (file) {
                let self = this;
                // 看支持不支持FileReader
                if (!file || !window.FileReader) return;

                if (/^image/.test(file.type)) {
                    // 创建一个reader
                    var reader = new FileReader();
                    // 将图片将转成 base64 格式
                    reader.readAsDataURL(file);
                    // 读取成功后的回调
                    reader.onloadend = function () {
                        self.dataUrl = this.result;
                    }
                }
            },
            imgUpload:function () {
                var upImg = this.$refs.upimg;
                upImg.click();
            },
            handleFileChange:function (e) {
                var _this = this;
                var upImg = _this.$refs.upimg;
                var img = upImg.files[0];
                console.log(img);
                // 在获取到文件对象进行预览就行了！
                this.imgPreview(img);
                if(img){
                    var newSize = (img.size/1024).toFixed(2);
                    if(newSize <= 10240){
                        var formData = new FormData();
                        formData.append("picture",img);
//                        return;
                        _this.$http.post("{:Url('File/uploadPicture')}",formData).then(function (res) {
                            var data = res.data;
                            console.log(data);
                        },function (res) {

                        });
//                        $.ajax({
//                            type:"post",
//                            url:"{:Url('File/uploadPicture')}",
//                            data:formData,
//                            processData : false,
//                            contentType : false,
//                            success:function(data){
//                                var msg = $.parseJSON(data);
//
//                                if(msg.code == 1){
//                                    var path = msg.data.path;
//                                    $(".head-img").attr('src',path);
//                                    $.ajax({
//                                        url:"setHeader",
//                                        type:'post',
//                                        data:{header:path},
//                                        dataType:'json',
//                                        success: function () {
//                                            mui.toast('上传成功',{ duration:'1000ms', type:'div' })
//                                        }
//                                    })
//                                } else {
//                                    mui.toast('上传失败',{ duration:'1000ms', type:'div' });
//                                    return;
//                                }
//                            }
//                        });
                    }
                }
            },
            subBtn: function () {
                var _this = this;

                if(!_this.isSubmit){
                    return;
                }
                _this.isSubmit = false;

                var subData = JSON.parse(JSON.stringify(_this.subData));
                console.log(subData);
                if(subData.type == "newCard"){
                    this.$http.post('addNewCard',subData).then(function (res) {
                        console.log(res.data);
                        _this.isSubmit = true;
                        var data = res.data;
                        if(data.code == 1){
                            swal({
                                title:"预约成功!",
                                text:'工作人员将会在2小时内联系您，洽谈具体事宜，请您耐心等待',
                                type:"success",
                                confirmButtonColor: "#fcc44b"
                            });
                        }
                    },function (res) {
                        _this.isSubmit = true;
                    })
                }
            }
        }
    })
</script>
{/block}