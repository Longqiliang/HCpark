{extend name="public/common"}

{block name="style"}
<title>车卡服务</title>
<link rel="stylesheet" href="/index/css/service/detail.css">
<style>
    body{
        background-color: #f0eff5;
    }
</style>
{/block}

{block name="body"}
<div id="app">
    <div class="card">
        <div class="card-tit">缴费信息</div>
        <div class="card-cell">
            <span>银行账户</span>
            <span>{{subData.bank_user}}</span>
        </div>
        <div class="card-cell">
            <span>账号名称</span>
            <span>{{subData.payment_bank}}</span>
        </div>
        <div v-if="subData.payment_alipay">
            <div class="card-cell bottom-inherit">
                <span class="card-hr">— — — or — — —</span>
            </div>
            <div class="card-cell">
                <span>支付宝账号</span>
                <span>{{subData.payment_alipay}}</span>
            </div>
            <div class="card-cell">
                <span>账号名称</span>
                <span>{{subData.ailpay_user}}</span>
            </div>
        </div>

    </div>
    <p class="prompt-message">转账时请备注个人信息（转账事由及内容）</p>
    <div class="card">
        <div class="card-tit">办理信息</div>
        <div class="card-upload">
            <div class="upload-img" v-for="(imgUrl,index) of dataUrl">
                <i class="del-img" @click="delImg(index)"></i>
                <img :src="imgUrl" class="img-responsive">
            </div>
            <div class="upload-box" @click="imgUpload" v-if="dataUrl.length < imgLength">
                <img src="/index/images/service/card/card-camera.png" >
                <span class="upload-info" >上传凭证</span>
            </div>
        </div>
        <form ref="myform">
            <input type="file" class="hide" id="upImg" accept="image/jpg, image/png, image/gif, image/jpeg" @change="handleFileChange" ref="upimg" capture="camera">
        </form>

    </div>
    <div class="card-btn-box payment-btn">
        <button class="btn btn-block btn-warning" @click="subBtn">提交</button>
    </div>
</div>
{/block}

{block name="script"}
<script>
    var data ={$data};
    console.log(data);
    var vm = new Vue({
        el:"#app",
        data:{
            subData:data,
            isSubmit:true,
            imgLength:3,
            payment_voucher:[],
            dataUrl:[],
            imgSrc:[]
        },
        methods: {
            delImg: function (e) {
                this.dataUrl.splice(e,1);
                this.imgSrc.splice(e,1);
                this.$refs.myform.reset();
            },
            imgPreview (file) {
                var self = this;
                // 看支持不支持FileReader
                if (!file || !window.FileReader) return;

                if (/^image/.test(file.type)) {
                    // 创建一个reader
                    var reader = new FileReader();
                    // 将图片将转成 base64 格式
                    reader.readAsDataURL(file);
                    // 读取成功后的回调
                    reader.onloadend = function () {
                        if(self.dataUrl.length >= self.imgLength){
                            return;
                        }else{
                            self.dataUrl.push(this.result) ;
                        }
                        console.log(self.dataUrl);
                    }
                }
            },
            imgUpload:function () {
                var upImg = this.$refs.upimg;
                upImg.click();
            },
            handleFileChange:function (e) {
                var _this = this;
                var upImg = _this.$refs.upimg;
                var img = upImg.files[0];
                console.log(img);

                if(img){
                    var newSize = (img.size/1024).toFixed(2);
                    if(newSize <= 10240){
                        // 在获取到文件对象进行预览
                        this.imgPreview(img);
                        this.imgSrc.push(img);
                        console.log(this.imgSrc);
                    }else{
                        _this.$toast("单张上传图片大小不能超过10M,请重新上传！");
                    }
                }
            },
            subBtn: function () {
                var _this = this;

                if(!_this.isSubmit){
                    return;
                }
                _this.isSubmit = false;

                var subData = JSON.parse(JSON.stringify(_this.subData));
                console.log(subData);
                 var formData = new FormData();
                var img = _this.imgSrc;
                console.log(img[0]);
                subData.payment_voucher = img;
//                for(var i=0;i<img.length;i++){
//                    formData.append("picture",img[i]);
//                    _this.$http.post("{:Url('File/uploadPicture')}",formData).then(function (res) {
//                        var data = res.data;
//                        console.log(data);
//                        if(data.code == 1){
//                            _this.payment_voucher.push(data.path);
//                        }
//                    },function (res) {
//
//                    });
//                }
//                return;


//                        return;
//                _this.$http.post("{:Url('File/uploadPicture')}",formData).then(function (res) {
//                    var data = res.data;
//                    console.log(data);
//                    if(data.code == 1){
//
//
//                    }
//                },function (res) {
//
//                });
                console.log(subData);
                this.$http.post('addNewCard',subData).then(function (res) {
                    console.log(res.data);
                    _this.isSubmit = true;
                    var data = res.data;
                    if(data.code == 1){
                        swal({
                            title:"预约成功!",
                            text:'您的缴费信息正在核对中<br/>核对完成后，将在个人中心中予以反馈<br/>请耐心等待，确认成功后<br/><span style="color:#333">请您在2小时内到海创大厦A座201领取车卡</span>',
                            html:true,
                            type:"success",
                            confirmButtonColor: "#fcc44b"
                        });
                    }
                },function (res) {
                    _this.isSubmit = true;
                });
//                if(subData.t == "newCard"){
//                    this.$http.post('addNewCard',subData).then(function (res) {
//                        console.log(res.data);
//                        _this.isSubmit = true;
//                        var data = res.data;
//                        if(data.code == 1){
//                            swal({
//                                title:"预约成功!",
//                                text:'您的缴费信息正在核对中<br/>核对完成后，将在个人中心中予以反馈<br/>请耐心等待，确认成功后<br/><span style="color:#333">请您在2小时内到海创大厦A座201领取车卡</span>',
//                                html:true,
//                                type:"success",
//                                confirmButtonColor: "#fcc44b"
//                            });
//                        }
//                    },function (res) {
//                        _this.isSubmit = true;
//                    })
//                }else{
//                    var type =subData.t;
//                    type = parseInt(type);
//                    console.log(_this.payment_voucher);
//                    if(!isNaN(type)){
//                            swal({
//                                title:"提交成功!",
//                                text:'您的缴费信息正在核对中<br/>核对完成后，将在个人中心中予以反馈<br/>请您耐心等待',
//                                html:true,
//                                type:"success",
//                                confirmButtonColor: "#fcc44b"
//                            });
//                    }
//                }
            }
        }
    })
</script>
{/block}